{% extends "base.html" %}
{% block title %}Admin - Dashboard{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
    <div class="flex items-center justify-between mb-8">
        <h1 class="text-2xl font-bold text-gray-800">Wahlen verwalten</h1>
        <a href="{{ url_for('admin_logout') }}" class="text-sm text-gray-500 hover:text-gray-700">Abmelden</a>
    </div>

    <!-- Schuleinstellungen -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Schuleinstellungen</h2>
        <form method="POST" action="{{ url_for('admin_school_settings') }}" enctype="multipart/form-data" class="flex flex-wrap gap-4 items-end">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="flex-1 min-w-[200px]">
                <label class="block text-sm text-gray-500 mb-1">Schulname</label>
                <input type="text" name="school_name" value="{{ school_settings.school_name }}" placeholder="z.B. Realschule Bobingen"
                    class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
            </div>
            <div>
                <label class="block text-sm text-gray-500 mb-1">Logo (optional)</label>
                <input type="file" name="logo" accept="image/*"
                    class="text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>
            <button type="submit"
                class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700 transition">
                Speichern
            </button>
        </form>
        {% if school_settings.logo_filename %}
        <div class="mt-4 flex items-center gap-4">
            <img src="{{ url_for('static', filename='uploads/' + school_settings.logo_filename) }}"
                alt="Schullogo" class="h-12 object-contain">
            <form method="POST" action="{{ url_for('admin_delete_logo') }}" class="inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="text-red-400 hover:text-red-600 text-sm">Logo entfernen</button>
            </form>
        </div>
        {% endif %}
    </div>

    <!-- Neue Wahl erstellen -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Neue Wahl erstellen</h2>
        <form method="POST" action="{{ url_for('admin_election_new') }}" class="flex flex-wrap gap-3 items-end">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="flex-1 min-w-[200px]">
                <label class="block text-sm text-gray-500 mb-1">Name</label>
                <input type="text" name="name" required placeholder="z.B. Schülersprecherwahl"
                    class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
            </div>
            <div class="w-28">
                <label class="block text-sm text-gray-500 mb-1">Jahr</label>
                <input type="number" name="year" required value="2026"
                    class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
            </div>
            <div class="w-28">
                <label class="block text-sm text-gray-500 mb-1">Max. Stimmen</label>
                <input type="number" name="max_votes" value="3" min="1" max="10"
                    class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
            </div>
            <button type="submit"
                class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700 transition">
                Erstellen
            </button>
        </form>
    </div>

    <!-- Bestehende Wahlen -->
    {% if elections %}
    <div class="space-y-4">
        {% for election in elections %}
        {% set stats = election_stats[election.id] %}
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5
            {%- if election.is_active %} border-l-4 border-l-green-400
            {%- elif election.is_ended %} border-l-4 border-l-gray-300
            {%- endif %}">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 flex-wrap">
                        <h3 class="text-lg font-semibold text-gray-800">{{ election.name }}</h3>
                        {% if election.is_ended %}
                        <span class="px-2 py-0.5 bg-gray-100 text-gray-500 text-xs font-semibold rounded-full">BEENDET</span>
                        {% elif election.is_active %}
                        <span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs font-semibold rounded-full animate-pulse-green">AKTIV</span>
                        {% elif election.was_activated %}
                        <span class="px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs font-semibold rounded-full">PAUSIERT</span>
                        {% elif stats.total_codes > 0 %}
                        <span class="px-2 py-0.5 bg-blue-50 text-blue-500 text-xs font-semibold rounded-full">BEREIT</span>
                        {% else %}
                        <span class="px-2 py-0.5 bg-gray-50 text-gray-400 text-xs font-semibold rounded-full">VORBEREITUNG</span>
                        {% endif %}
                    </div>
                    <p class="text-sm text-gray-500 mt-0.5">
                        {{ election.year }} &middot; Max. {{ election.max_votes }} Stimmen &middot; {{ election.candidates|length }} Kandidaten
                    </p>

                    {# Status-Block: Fortschritt und Ergebnisse #}
                    {% if election.was_activated or election.is_ended %}
                    <div class="mt-3">
                        {# Fortschrittsbalken #}
                        <div class="flex items-center gap-3">
                            <div class="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
                                <div class="h-full rounded-full transition-all
                                    {%- if election.is_ended %} bg-gray-400
                                    {%- elif election.is_active %} bg-green-400
                                    {%- else %} bg-yellow-400
                                    {%- endif %}"
                                    style="width: {{ stats.pct }}%"></div>
                            </div>
                            <span class="text-sm font-semibold text-gray-700 tabular-nums whitespace-nowrap">
                                {{ stats.pct }} %
                            </span>
                            <span class="text-xs text-gray-400 whitespace-nowrap">
                                {{ stats.used_codes }} / {{ stats.total_codes }} Stimmen
                            </span>
                        </div>
                        {# Führender Kandidat #}
                        {% if stats.top %}
                        <p class="text-xs text-gray-500 mt-1.5">
                            {% if election.is_ended %}Gewinner:{% else %}Aktuell führend:{% endif %}
                            <span class="font-semibold text-gray-700">{{ stats.top.name }}</span>
                            <span class="text-gray-400">({{ stats.top.votes }} Stimmen)</span>
                        </p>
                        {% endif %}
                    </div>
                    {% elif stats.total_codes > 0 %}
                    <p class="text-xs text-gray-400 mt-2">{{ stats.total_codes }} Codes generiert &middot; Wahl noch nicht gestartet</p>
                    {% else %}
                    <p class="text-xs text-gray-400 mt-2">Noch keine Codes generiert</p>
                    {% endif %}
                </div>
                <div class="flex gap-2">
                    <a href="{{ url_for('admin_election', election_id=election.id) }}"
                        class="inline-flex items-center gap-1.5 px-4 py-2 text-sm font-medium text-blue-600 border border-blue-200 rounded-lg hover:bg-blue-50 transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                        Bearbeiten
                    </a>
                    <a href="{{ url_for('admin_codes', election_id=election.id) }}"
                        class="inline-flex items-center gap-1.5 px-4 py-2 text-sm font-medium text-gray-600 border border-gray-200 rounded-lg hover:bg-gray-50 transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/></svg>
                        Codes
                    </a>
                    {% if election.was_activated %}
                    <a href="{{ url_for('admin_results', election_id=election.id) }}"
                        class="inline-flex items-center gap-1.5 px-4 py-2 text-sm font-medium text-gray-600 border border-gray-200 rounded-lg hover:bg-gray-50 transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                        Ergebnisse
                    </a>
                    <a href="{{ url_for('admin_present', election_id=election.id) }}"
                        class="inline-flex items-center gap-1.5 px-4 py-2 text-sm font-medium text-indigo-600 border border-indigo-200 rounded-lg hover:bg-indigo-50 transition"
                        title="Präsentationsmodus">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                        Präsentation
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-center text-gray-400 py-12">Noch keine Wahlen vorhanden.</p>
    {% endif %}
</div>
{% endblock %}
