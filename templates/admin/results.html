{% extends "base.html" %}
{% block title %}{{ election.name }} - Ergebnisse{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
    <div class="mb-6">
        <a href="{{ url_for('admin_dashboard') }}" class="text-sm text-blue-600 hover:underline">&larr; Zurück</a>
        <div class="flex items-center gap-3 mt-1">
            <h1 class="text-2xl font-bold text-gray-800">Ergebnisse: {{ election.name }}</h1>
            <a href="{{ url_for('admin_present', election_id=election.id) }}"
                class="inline-flex items-center gap-1.5 px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition"
                title="Präsentationsmodus">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                Präsentation
            </a>
        </div>
    </div>

    <!-- Wahlbeteiligung -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
        <div class="flex items-center justify-between">
            <div>
                <div class="text-sm text-gray-500">Wahlbeteiligung</div>
                <div class="text-3xl font-bold text-gray-800" id="participation">-</div>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-500">Abgestimmt</div>
                <div class="text-xl font-semibold text-gray-700"><span id="usedCodes">-</span> / <span id="totalCodes">-</span></div>
            </div>
        </div>
    </div>

    <!-- Balkendiagramm -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <canvas id="resultsChart" height="400"></canvas>
    </div>

    <!-- Rangliste -->
    <div id="rankingList" class="mt-6 space-y-3"></div>

    <p class="text-center text-xs text-gray-400 mt-6">Aktualisiert sich automatisch alle 5 Sekunden</p>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
(function() {
    const electionId = {{ election.id }};
    let chart = null;

    function fetchResults() {
        fetch('/api/election/' + electionId + '/results')
            .then(r => r.json())
            .then(data => {
                updateChart(data);
                updateRanking(data);
                updateParticipation(data);
            });
    }

    function updateChart(data) {
        const labels = data.results.map(r => r.name + (r.class_name ? ' (' + r.class_name + ')' : ''));
        const votes = data.results.map(r => r.votes);
        const colors = data.results.map((_, i) => i < 3 ? '#2563eb' : '#94a3b8');

        if (chart) {
            chart.data.labels = labels;
            chart.data.datasets[0].data = votes;
            chart.data.datasets[0].backgroundColor = colors;
            chart.update();
        } else {
            const ctx = document.getElementById('resultsChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Stimmen',
                        data: votes,
                        backgroundColor: colors,
                        borderRadius: 6,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }
    }

    function updateRanking(data) {
        const list = document.getElementById('rankingList');
        list.innerHTML = '';
        data.results.forEach((r, i) => {
            const isTop = i < 3;
            const div = document.createElement('div');
            div.className = 'bg-white rounded-xl shadow-sm border p-4 flex items-center gap-4 ' +
                (isTop ? 'border-blue-200 bg-blue-50' : 'border-gray-100');
            div.innerHTML = `
                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg ${isTop ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-500'}">
                    ${i + 1}
                </div>
                <div class="flex-1">
                    <div class="font-semibold text-gray-800">${r.name}</div>
                    ${r.class_name ? '<div class="text-sm text-gray-500">Klasse ' + r.class_name + '</div>' : ''}
                </div>
                <div class="text-2xl font-bold ${isTop ? 'text-blue-600' : 'text-gray-500'}">${r.votes}</div>
            `;
            list.appendChild(div);
        });
    }

    function updateParticipation(data) {
        document.getElementById('usedCodes').textContent = data.used_codes;
        document.getElementById('totalCodes').textContent = data.total_codes;
        const pct = data.total_codes > 0 ? Math.round(data.used_codes / data.total_codes * 100) : 0;
        document.getElementById('participation').textContent = pct + ' %';
    }

    fetchResults();
    setInterval(fetchResults, 5000);
})();
</script>
{% endblock %}
